{% extends "base.html" %}
{% block content %}
<style>
  body {
    background: url("{{ url_for('static', filename='images/92672eb7-4f27-4b48-952c-b1b462ab0593.jpg') }}")
      no-repeat center center / cover;
    font-family: 'Poppins', sans-serif;
    margin: 0;
    overflow: hidden;
  }

  .petals {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }
  .petal {
    position: absolute;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    animation: fall linear infinite;
  }
  @keyframes fall {
    0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
    100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
  }

  .page-title {
    font-weight: 700;
    text-align: center;
    font-size: 2.5rem;
    margin: 40px 0 25px;
    color: #fff;
    text-shadow: 0 0 10px rgba(255,182,193,0.9);
  }

  .container {
    max-width: 600px;
    margin: 0 auto 80px auto;
    padding: 30px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    border-radius: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    text-align: center;
    color: #fff;
  }

  video, canvas {
    width: 100%;
    max-width: 500px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.25);
    margin-bottom: 20px;
  }

  button {
    padding: 12px 30px;
    border-radius: 12px;
    border: none;
    background: linear-gradient(90deg, #ff8fab, #ffb3c6);
    color: white;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 4px 12px rgba(255,182,193,0.6);
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255,182,193,0.7);
  }

  #results {
    margin-top: 20px;
    max-height: 250px;
    overflow-y: auto;
    border-radius: 12px;
    padding: 15px;
    color: #fff;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .prediction {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(255,255,255,0.15);
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    transition: transform 0.3s ease, background 0.3s ease;
  }
</style>

<div class="petals" id="petals-container"></div>

<h1 class="page-title">ðŸŒ¸ Live Bloom Detection Camera ðŸŒ¸</h1>

<div class="container">
  <video id="video" autoplay playsinline></video>
  <button id="captureBtn">Capture & Detect Bloom</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="results"></div>
</div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const captureBtn = document.getElementById('captureBtn');
  const resultsDiv = document.getElementById('results');
  const ctx = canvas.getContext('2d');
  const petalsContainer = document.getElementById('petals-container');

  // Camera access
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(err => {
      alert('Camera access denied or unavailable.');
      console.error(err);
    });

  const speciesList = ["Rose", "Sunflower", "Tulip", "Daisy", "Lotus", "Marigold"];
  const stageList = ["No Bloom", "Partial Bloom", "Full Bloom"];
  const colors = {
    "No Bloom": "rgba(200,200,200,0.8)",
    "Partial Bloom": "rgba(255,182,193,0.8)",
    "Full Bloom": "rgba(255,105,180,0.9)"
  };
  const petalCounts = { "No Bloom": 10, "Partial Bloom": 20, "Full Bloom": 40 };
  const petalSpeeds = { "No Bloom": 12, "Partial Bloom": 8, "Full Bloom": 5 };

  function generatePetals(stage) {
    petalsContainer.innerHTML = '';
    const count = petalCounts[stage];
    const speed = petalSpeeds[stage];
    for (let i = 0; i < count; i++) {
      const petal = document.createElement('div');
      petal.className = 'petal';
      petal.style.left = Math.random() * 100 + '%';
      petal.style.width = 12 + Math.random() * 10 + 'px';
      petal.style.height = 12 + Math.random() * 10 + 'px';
      petal.style.background = colors[stage];
      petal.style.animationDuration = (speed + Math.random() * 5) + 's';
      petal.style.animationDelay = (Math.random() * 5) + 's';
      petalsContainer.appendChild(petal);
    }
  }

  function addPrediction(species, stage) {
    const div = document.createElement('div');
    div.className = 'prediction';
    div.style.background = colors[stage];
    div.textContent = `ðŸŒ¸ Prediction: ${species}, Stage: ${stage}`;
    div.style.transform = "scale(1.1)";
    resultsDiv.prepend(div);
    setTimeout(() => { div.style.transform = "scale(1)"; }, 300);
  }

  captureBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Generate multiple random predictions
    const count = Math.floor(Math.random() * 3) + 1; // 1-3 predictions
    for (let i = 0; i < count; i++) {
      const species = speciesList[Math.floor(Math.random() * speciesList.length)];
      const stage = stageList[Math.floor(Math.random() * stageList.length)];
      addPrediction(species, stage);
      generatePetals(stage); // Update petals according to last stage
    }
  });

  // Initial petals
  generatePetals("No Bloom");
</script>
{% endblock %}
